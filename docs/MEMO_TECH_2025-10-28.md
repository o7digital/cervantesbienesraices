Mémoire technique — Cervantes Bienes Raíces
Date: 28 octobre 2025

Objectif
- Documenter l’incident des annonces « No publicada » visibles sur le listing public et les correctifs appliqués.

Contexte
- Source des données: EasyBroker (`/v1/properties`).
- Pages impactées: `listing_06` (liste) et potentiellement page détail.
- Variables d’environnement: `EB_API_KEY` en `.env.local`.

Symptômes observés
- Des biens « No publicada » (ex. Casa Coyoacan, Departamentos en Renta/Venta) apparaissaient sur le site public.

Diagnostic (cause racine)
- Côté client (dev): le composant appelait explicitement l’API avec `status=No publicada`, ce qui forçait l’affichage de ces biens en environnement de développement.
  - Fichier: `cervantesbienesraices/src/components/inner-listing/listing-06/ListingSixArea.tsx:83` (ancien code).
- Côté API: l’endpoint ne filtrait pas, par défaut, les résultats non publiés quand aucun `status` n’était fourni.
  - Fichier: `cervantesbienesraices/src/pages/api/properties.ts`.
- Particularités d’EasyBroker: statut présent sous `publication_status`, `status`, et parfois booléen `publicly_visible`.

Correctifs appliqués (branche `dev`)
1) Front — suppression du fetch « No publicada » en dev
   - Commit: `ade0c22`
   - Fichier modifié: `cervantesbienesraices/src/components/inner-listing/listing-06/ListingSixArea.tsx:83`
   - Changement: toujours appeler `"/api/properties"` (l’API filtre désormais par défaut côté serveur).

2) API — filtre par défaut aux annonces publiées
   - Commit: `98c1e05`
   - Fichier modifié: `cervantesbienesraices/src/pages/api/properties.ts`
   - Ajout d’un prédicat `isPublished` robuste qui:
     - inclut par défaut les biens, sauf si un indicateur explicite « No publicada/Unpublished » est détecté,
     - exclut si `publicly_visible === false`.
   - Application du prédicat par défaut sur les deux chemins (pagination simple et agrégation de pages):
     - `cervantesbienesraices/src/pages/api/properties.ts:85`
     - `cervantesbienesraices/src/pages/api/properties.ts:130`

Effet attendu
- En l’absence de paramètre `status`, l’API retourne uniquement des annonces publiées.
- Le listing public n’affiche plus les biens « No publicada ».

Tests réalisés
- Build Next: OK (`npm run build`).
- Vérification locale de l’API:
  - `GET /api/properties` -> retourne des biens publiés, aucun item avec `publicly_visible === false` ni statut explicite « No publicada ».
  - `GET /api/properties?status=No publicada` -> retourne uniquement les non publiées (utile pour vérif interne).
- Listing `/listing_06` -> affichage des biens publiés uniquement.

Recommandations complémentaires (non bloquantes)
- Page détail: bloquer l’accès aux biens non publiés (retour 404).
  - Fichier concerné: `cervantesbienesraices/src/pages/api/property/[id].ts` (vérifier statut avant de répondre 200).
- Observabilité: journaliser le nombre d’items filtrés côté API (niveau debug) si besoin.
- Process: valider en Preview Vercel sur `dev` avant merge vers `main`.

Notes connexes (hors repo Cervantes)
- Un commit accidentel avait été effectué dans le dépôt LCQC au niveau du HOME de la machine.
- Mesure de mitigation: le `.git` du HOME a été sauvegardé/neutralisé pour éviter tout commit croisé.

Prochaines étapes
- Valider la Preview Vercel branche `dev` (que les « No publicada » n’apparaissent plus).
- Optionnel: implémenter la protection sur la page détail.
- Merger vers `main` après validation.

Références de fichiers
- `cervantesbienesraices/src/pages/api/properties.ts:44`
- `cervantesbienesraices/src/pages/api/properties.ts:85`
- `cervantesbienesraices/src/pages/api/properties.ts:130`
- `cervantesbienesraices/src/components/inner-listing/listing-06/ListingSixArea.tsx:83`

